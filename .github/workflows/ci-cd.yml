name: CI/CD to Minikube

on:
  push:
    branches: [ main ]

jobs:
  build-deploy:
    runs-on: self-hosted

    env:
      DOCKER_HUB_USER: soumya118
      IMAGE_CLIENT: soumya118/resume-builder-client
      IMAGE_SERVER: soumya118/resume-builder-server
      K8S_PATH: ./K8s
      NAMESPACE: resume-builder
      KUBECONFIG: C:\Users\Soumyadeep Ghosh\.kube\config

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set Commit Tag
        id: vars
        shell: powershell
        run: |
          $commit = git rev-parse --short HEAD
          echo "commit=$commit" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "Using commit tag: $commit"

      - name: Verify Docker and Kubernetes Setup
        shell: powershell
        run: |
          docker --version
          kubectl version --client
          kubectl config use-context minikube
          kubectl cluster-info

      - name: Build and Tag Docker Images
        shell: powershell
        run: |
          $env:DOCKER_BUILDKIT = '1'
          docker context use default

          $commit = "${{ steps.vars.outputs.commit }}"
          $clientRepo = "${{ env.IMAGE_CLIENT }}"
          $serverRepo = "${{ env.IMAGE_SERVER }}"

          $clientTag = "$clientRepo:$commit"
          $serverTag = "$serverRepo:$commit"

          Write-Host "Building Client Image: $clientTag"
          docker build -t $clientTag ./clients
          docker tag $clientTag "$clientRepo:latest"

          Write-Host "Building Server Image: $serverTag"
          docker build -t $serverTag ./server
          docker tag $serverTag "$serverRepo:latest"

          Write-Host "Docker build completed successfully."

      - name: Login to DockerHub
        shell: powershell
        run: |
          echo "${{ secrets.DOCKER_PASS }}" | docker login -u "${{ secrets.DOCKER_USER }}" --password-stdin

      - name: Push Client Image
        shell: powershell
        run: |
          $commit = "${{ steps.vars.outputs.commit }}"
          docker push "$env:IMAGE_CLIENT:$commit"
          docker push "$env:IMAGE_CLIENT:latest"

      - name: Push Server Image
        shell: powershell
        run: |
          $commit = "${{ steps.vars.outputs.commit }}"
          docker push "$env:IMAGE_SERVER:$commit"
          docker push "$env:IMAGE_SERVER:latest"

      - name: Deploy to Kubernetes
        shell: powershell
        run: |
          $env:KUBECONFIG = "C:\Users\Soumyadeep Ghosh\.kube\config"
          mkdir -Force k8s_tmp
          Copy-Item -Recurse $env:K8S_PATH\* k8s_tmp\
          $commit = "${{ steps.vars.outputs.commit }}"

          Get-ChildItem k8s_tmp\*.yaml | ForEach-Object {
            (Get-Content $_.FullName) `
              -replace 'IMAGE_CLIENT_PLACEHOLDER', "$env:IMAGE_CLIENT:$commit" `
              -replace 'IMAGE_SERVER_PLACEHOLDER', "$env:IMAGE_SERVER:$commit" |
              Set-Content $_.FullName
          }

          kubectl apply -f k8s_tmp/namespace.yaml
          kubectl apply -f k8s_tmp/ --namespace $env:NAMESPACE

      - name: Wait for Rollout
        shell: powershell
        run: |
          $env:KUBECONFIG = "C:\Users\Soumyadeep Ghosh\.kube\config"
          kubectl rollout status deployment/client -n $env:NAMESPACE --timeout=180s
          kubectl rollout status deployment/server -n $env:NAMESPACE --timeout=180s

      - name: Deployment Successful
        if: success()
        shell: powershell
        run: |
          Write-Host "Deployment successful for commit: ${{ steps.vars.outputs.commit }}"