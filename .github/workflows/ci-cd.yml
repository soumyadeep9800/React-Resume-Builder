name: CI/CD to Minikube

on:
  push:
    branches: [ main ]

jobs:
  build-deploy:
    runs-on: self-hosted

    env:
      DOCKER_HUB_USER: soumya118
      IMAGE_CLIENT: soumya118/resume-builder-client
      IMAGE_SERVER: soumya118/resume-builder-server
      K8S_PATH: ./K8s
      NAMESPACE: resume-builder

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set Commit Tag
        id: vars
        shell: powershell
        run: |
          $commit = git rev-parse --short HEAD
          echo "commit=$commit" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host 'Using commit tag:' $commit

      - name: Build and Tag Docker Images
        shell: powershell
        run: |
          $env:DOCKER_BUILDKIT = '1'

          $clientLatest = "$env:IMAGE_CLIENT" + ":latest"
          $serverLatest = "$env:IMAGE_SERVER" + ":latest"
          $clientTag = "$env:IMAGE_CLIENT" + ":${{ steps.vars.outputs.commit }}"
          $serverTag = "$env:IMAGE_SERVER" + ":${{ steps.vars.outputs.commit }}"

          try {
            docker pull $clientLatest
          } catch {
            Write-Host 'No cache found for client'
          }

          try {
            docker pull $serverLatest
          } catch {
            Write-Host 'No cache found for server'
          }

          Write-Host 'Building Docker images...'
          docker build --cache-from=$clientLatest -t $clientTag ./clients
          docker build --cache-from=$serverLatest -t $serverTag ./server

          docker tag $clientTag $clientLatest
          docker tag $serverTag $serverLatest

      - name: Push Client Image
        shell: powershell
        run: |
          $clientLatest = "$env:IMAGE_CLIENT" + ":latest"
          $clientTag = "$env:IMAGE_CLIENT" + ":${{ steps.vars.outputs.commit }}"

          docker logout
          Write-Host 'Logging in to Docker Hub...'
          $loginResult = echo "${{ secrets.DOCKER_PASS }}" | docker login -u "${{ secrets.DOCKER_USER }}" --password-stdin 2>&1

          if ($loginResult -match 'Login Succeeded') {
              Write-Host 'Docker login succeeded'
          } else {
              Write-Host 'Docker login may have failed'
              Write-Host $loginResult
          }

          Write-Host 'Pushing Client Images...'
          docker push $clientTag
          docker push $clientLatest

      - name: Push Server Image
        shell: powershell
        run: |
          $serverLatest = "$env:IMAGE_SERVER" + ":latest"
          $serverTag = "$env:IMAGE_SERVER" + ":${{ steps.vars.outputs.commit }}"

          docker logout
          Write-Host 'Logging in to Docker Hub...'
          $loginResult = echo "${{ secrets.DOCKER_PASS }}" | docker login -u "${{ secrets.DOCKER_USER }}" --password-stdin 2>&1

          if ($loginResult -match 'Login Succeeded') {
              Write-Host 'Docker login succeeded'
          } else {
              Write-Host 'Docker login may have failed'
              Write-Host $loginResult
          }

          Write-Host 'Pushing Server Images...'
          docker push $serverTag
          docker push $serverLatest

      - name: Deploy to Kubernetes
        shell: powershell
        run: |
          mkdir k8s_tmp -Force
          Copy-Item -Recurse $env:K8S_PATH\* k8s_tmp\
          $commit = "${{ steps.vars.outputs.commit }}"
          $clientTag = "$env:IMAGE_CLIENT" + ":$commit"
          $serverTag = "$env:IMAGE_SERVER" + ":$commit"

          Write-Host 'Preparing Kubernetes manifests...'
          Get-ChildItem k8s_tmp\*.yaml | ForEach-Object {
            (Get-Content $_.FullName) `
              -replace 'IMAGE_CLIENT_PLACEHOLDER', $clientTag `
              -replace 'IMAGE_SERVER_PLACEHOLDER', $serverTag |
              Set-Content $_.FullName
          }

          Write-Host 'Applying Kubernetes resources...'
          kubectl apply -f k8s_tmp/namespace.yaml
          kubectl apply -f k8s_tmp/ --namespace $env:NAMESPACE

      - name: Wait for Rollout
        shell: powershell
        run: |
          Write-Host 'Waiting for rollout in namespace' $env:NAMESPACE '...'
          kubectl rollout status deployment/client -n $env:NAMESPACE --timeout=180s
          kubectl rollout status deployment/server -n $env:NAMESPACE --timeout=180s

      - name: Deployment Success
        if: success()
        shell: powershell
        run: |
          Write-Host 'Deployment successful in namespace:' $env:NAMESPACE
          Write-Host 'Client Image:' "$env:IMAGE_CLIENT:${{ steps.vars.outputs.commit }}"
          Write-Host 'Server Image:' "$env:IMAGE_SERVER:${{ steps.vars.outputs.commit }}"